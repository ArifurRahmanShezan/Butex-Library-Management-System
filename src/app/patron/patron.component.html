<div class="container">
  <h2>Library Management System</h2>

  <!-- Tabs -->
  <div class="tabs">
    <button [class.active]="currentTab==='category'" (click)="switchTab('category')">Category</button>
    <button [class.active]="currentTab==='privilege'" (click)="switchTab('privilege')">Privilege</button>
    <button [class.active]="currentTab==='patron'" (click)="switchTab('patron')">Patrons</button>
  </div>

  <!-- ================= CATEGORY TAB ================= -->
  <div *ngIf="currentTab==='category'">
    <div class="header">
      <h3>Categories</h3>
      <button (click)="openModal('category')" class="btn btn-success">+ Add Category</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Name</th>
          <th>Description</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let cat of categories; let i = index">
          <td>{{i+1}}</td>
          <td>{{cat.name}}</td>
          <td>{{cat.description}}</td>
          <td class="action-buttons">
            <button class="btn btn-primary" (click)="openModal('category', i)">Edit</button>
            <button class="btn btn-danger" (click)="deleteCategory(i)">Delete</button>
          </td>
        </tr>
        <tr *ngIf="categories.length === 0">
          <td colspan="4" class="empty-msg">No categories found.</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- ================= PRIVILEGE TAB ================= -->
  <div *ngIf="currentTab==='privilege'">
    <div class="header">
      <h3>Privileges</h3>
      <button (click)="openModal('privilege')" class="btn btn-success">+ Add Privilege</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Category</th>
          <th>Max Items on Loan</th>
          <th>Loan Period (Days)</th>
          <th>Max Renewals</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let p of matrix; let i = index">
          <td>{{ i + 1 }}</td>
          <td>{{ p.categoryName }}</td>
          <td>{{ p.maxItemsOnLoan }}</td>
          <td>{{ p.loanPeriodDays }}</td>
          <td>{{ p.maxRenewals }}</td>
          <td class="action-buttons">
            <button class="btn btn-primary" (click)="openModal('privilege', i)">Edit</button>
            <button class="btn btn-danger" (click)="deletePrivilege(i)">Delete</button>
          </td>
        </tr>
        <tr *ngIf="matrix.length === 0">
          <td colspan="6" class="empty-msg">No privileges added yet.</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- ================= PATRON TAB ================= -->
  <div *ngIf="currentTab==='patron'">
    <div class="header">
      <h3>Library Patrons</h3>
      <button (click)="openModal('patron')" class="btn btn-success">+ Add Patron</button>
    </div>

    <table class="patron-table">
      <thead>
        <tr>
          <th>Library ID</th>
          <th>Name</th>
          <th>Email</th>
          <th>Category</th>
          <th>Department</th>
          <th>Active</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let patron of patrons; let i = index">
          <td>{{ patron.libraryId }}</td>
          <td>{{ patron.name }}</td>
          <td>{{ patron.email }}</td>
          <td>{{ patron.patronCategory?.name || patron.category }}</td>
          <td>{{ patron.department?.name || patron.department }}</td>
          <td>{{ patron.active ? 'Yes' : 'No' }}</td>
          <td class="action-buttons">
            <button class="btn btn-primary" (click)="openModal('patron', i)">Edit</button>
            <button class="btn btn-danger" (click)="deletePatron(patron.id)">Delete</button>
          </td>
        </tr>
        <tr *ngIf="patrons.length === 0">
          <td colspan="7" class="empty-msg">No patrons registered yet.</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- ================= MODAL ================= -->
  <div class="modal" *ngIf="modalOpen">
    <div class="modal-content">
      <span class="close-btn" (click)="closeModal()">&times;</span>
      <h3>{{editingIndex!==null ? 'Edit ' : 'Add '}}{{modalType | titlecase}}</h3>

      <!-- CATEGORY FORM -->
      <form *ngIf="modalType==='category'"
        (ngSubmit)="editingIndex !== null ? updateCategory(editingIndex) : addCategory()">
        <label>Name</label>
        <input type="text" [(ngModel)]="catName" name="catName" placeholder="Category Name" required>
        <label>Description</label>
        <textarea [(ngModel)]="catDesc" name="catDesc" placeholder="Description" required></textarea>

        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" (click)="closeModal()">Cancel</button>
          <button type="submit" class="btn btn-success">{{ editingIndex !== null ? 'Update' : 'Add' }} Category</button>
        </div>
      </form>

      <!-- PRIVILEGE FORM -->
      <form *ngIf="modalType==='privilege'" (ngSubmit)="submitPrivilege()">
        <label>Category</label>
        <select [(ngModel)]="selectedCategoryId" name="category" required>
          <option *ngFor="let c of categories" [ngValue]="c.id">{{c.name}}</option>
        </select>

        <label>Max Items on Loan</label>
        <input type="number" [(ngModel)]="maxItemsOnLoan" name="maxItemsOnLoan" required>

        <label>Loan Period (Days)</label>
        <input type="number" [(ngModel)]="loanPeriodDays" name="loanPeriodDays" required>

        <label>Max Renewals</label>
        <input type="number" [(ngModel)]="maxRenewals" name="maxRenewals" required>

        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" (click)="closeModal()">Cancel</button>
          <button type="submit" class="btn btn-success">{{ editingIndex !== null ? 'Update' : 'Add' }}
            Privilege</button>
        </div>
      </form>

      <!-- PATRON FORM -->
      <form *ngIf="modalType==='patron'" (ngSubmit)="editingIndex !== null ? updatePatron() : onSubmit()">
        <label>Library ID</label>
        <input type="text" [(ngModel)]="libraryId" name="libraryId" required [readonly]="editingIndex !== null">

        <label>Name</label>
        <input type="text" [(ngModel)]="name" name="name" required>

        <label>Email</label>
        <input type="email" [(ngModel)]="email" name="email" required>

        <label>Category</label>
        <select [(ngModel)]="selectedCategory" name="patronCategory" required>
          <option *ngFor="let cat of patronCategories" [ngValue]="cat.id">{{ cat.name }}</option>
        </select>

        <label>Department</label>
        <select [(ngModel)]="selectedDepartment" name="department" required>
          <option *ngFor="let dep of departments" [ngValue]="dep.id">{{ dep.name }}</option>
        </select>

        <label class="checkbox">
          <input type="checkbox" [(ngModel)]="active" name="active"> Active
        </label>

        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" (click)="closeModal()">Cancel</button>
          <button type="submit" class="btn btn-success">{{ editingIndex !== null ? 'Update' : 'Add' }} Patron</button>
        </div>
      </form>
    </div>
  </div>
</div>
